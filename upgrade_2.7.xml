<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Enhanced_PM_System</id>
<version>2.8</version>

<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[// Remove any recipients that have the current user in their pm ignore list:
	foreach ($context['recipients']['to'] as $id => $user)
	{
		if (in_array($user_info['id'], $user['pm_ignore_list']))
		{
			$context['send_log']['failed'][] = sprintf($txt['pm_error_ignored_by_user'], $user['name']);
			unset($context['recipients']['to'][$id]);
		}
	}
	foreach ($context['recipients']['bcc'] as $id => $user)
	{
		if (in_array($user_info['id'], $user['pm_ignore_list']))
		{
			$context['send_log']['failed'][] = sprintf($txt['pm_error_ignored_by_user'], $user['name']);
			unset($context['recipients']['bcc'][$id]);
		}
	}]]></search>
		<add><![CDATA[// Remove any recipients that have the current user in their pm ignore list:
	if (!empty($context['recipients']['to']))
	{
		foreach ($context['recipients']['to'] as $id => $user)
		{
			if (isset($user['pm_ignore_list']) && is_array($user['pm_ignore_list']) && in_array($user_info['id'], $user['pm_ignore_list']))
			{
				$context['send_log']['failed'][] = sprintf($txt['pm_error_ignored_by_user'], $user['name']);
				unset($context['recipients']['to'][$id]);
			}
		}
	}
	if (!empty($context['recipients']['bcc']))
	{
		foreach ($context['recipients']['bcc'] as $id => $user)
		{
			if (isset($user['pm_ignore_list']) && is_array($user['pm_ignore_list']) && in_array($user_info['id'], $user['pm_ignore_list']))
			{
				$context['send_log']['failed'][] = sprintf($txt['pm_error_ignored_by_user'], $user['name']);
				unset($context['recipients']['bcc'][$id]);
			}
		}
	}]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[unset($labels[0]);]]></search>
		<add><![CDATA[//unset($labels[0]);]]></add>
	</operation>
</file>
<file name="$boarddir/Themes/core/PersonalMessage.template.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[<span id="actionAddHere"></span><br />';
//					<a href="#" onclick="addActionOption(); return false;" id="addonjs2" style="display: none;">(', $txt['pm_rule_add_action'], ')</a>
	echo ']]></search>
	</operation>
		<add><![CDATA[<span id="actionAddHere"></span><br />
					<a href="#" onclick="addActionOption(); return false;" id="addonjs2" style="display: none;">(', $txt['pm_rule_add_action'], ')</a>]]></add>
</file>
<file name="$themedir/PersonalMessage.template.php">
	<operation>
		<search position="replace"><![CDATA[<span id="actionAddHere"></span><br />';
//					<a href="#" onclick="addActionOption(); return false;" id="addonjs2" style="display: none;">(', $txt['pm_rule_add_action'], ')</a>
	echo ']]></search>
		<add><![CDATA[<span id="actionAddHere"></span><br />
					<a href="#" onclick="addActionOption(); return false;" id="addonjs2" style="display: none;">(', $txt['pm_rule_add_action'], ')</a>]]></add>
	</operation>
</file>
</modification>