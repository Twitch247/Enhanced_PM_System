<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:SentItems</id>
<version>1.5</version>

<file name="$sourcedir/PersonalMessage.php">
<!---------------------------------------------------------------------------->
<!-- Reversed v1.4 Fix for Undefined Var in PersonalMessage.php             -->
<!-- Note: This wasn't the problem....  See next fix for problem :(         -->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[$isReceived = !isset($context['edit']) && $smcFunc['db_num_rows']($request) != 0;]]></search>
		<add><![CDATA[$isReceived = !$context['edit'] && $smcFunc['db_num_rows']($request) != 0;]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Prob/Fix from Version 1.1 went missing somehow...  Reinstating it here -->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="after"><![CDATA[$context['reply'] = isset($_REQUEST['pmsg']) || isset($_REQUEST['quote']);]]></search>
		<add><![CDATA[$context['edit'] = isset($_REQUEST['pmsg']) && isset($_REQUEST['edit']);
	]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Bug Fix in ApplyRules() allows assigning a PM to more than 1 folder    -->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[// Get a basic pot started!
							if (!isset($actions['labels'][$row['id_pm']]))
								$actions['labels'][$row['id_pm']] = empty($row['labels']) ? array() : explode(',', $row['labels']);
							$actions['labels'][$row['id_pm']][] = $ruleAction['v'];]]></search>
		<add><![CDATA[// Get a basic pot started!
							$actions['labels'][$row['id_pm']] = array($ruleAction['v']);]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Bug Fix in sendpm() allowed user to be notified upon editing PM if     -->
<!-- NOT READ even if already notified of new PM for user	                -->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/Subs-Post.php">
	<operation>
		<search position="replace"><![CDATA[SELECT id_member, is_read
			FROM {db_prefix}pm_recipients
			WHERE id_pm = {int:id_pm}',
			array(
				'id_pm' => $pmsg,
			)
		);
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$already_emailed[$row['id_member']] = $row['is_read'];]]></search>
		<add><![CDATA[SELECT id_member
			FROM {db_prefix}pm_recipients
			WHERE id_pm = {int:id_pm}',
			array(
				'id_pm' => $pmsg,
			)
		);
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$already_emailed[$row['id_member']] = true;]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Incorrect image assigned to Outbox PMs - reported by FragaCampos       -->
<!---------------------------------------------------------------------------->
<file name="$themedir/PersonalMessage.template.php">
	<operation>
		<search position="replace"><![CDATA[', $context['folder'] == 'sent' ? $eps_mail_read : ($context['folder'] == 'outbox' ? $eps_mail_unread : ($message['is_replied_to'] ? $eps_mail_reply : ($message['is_unread']  ? $eps_mail_unread : $eps_mail_read))), '</td>]]></search>
		<add><![CDATA[', $context['folder'] == 'sent' ? $eps_mail_read : ($context['folder'] == 'unread' ? $eps_mail_unread : ($message['is_replied_to'] ? $eps_mail_reply : ($message['is_unread']  ? $eps_mail_unread : $eps_mail_read))), '</td>]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Innocent workaround because version 1.4 already contains this fix :p   -->
<!-- Otherwise, Package Manager throws an error because search isn't there  -->
<!---------------------------------------------------------------------------->
<file name="$boarddir/Themes/core/PersonalMessage.template.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[', $context['folder'] == 'sent' ? $eps_mail_read : ($context['folder'] == 'unread' ? $eps_mail_unread : ($message['is_replied_to'] ? $eps_mail_reply : ($message['is_unread']  ? $eps_mail_unread : $eps_mail_read))), '</td>]]></search>
		<add><![CDATA[', $context['folder'] == 'sent' ? $eps_mail_read : ($context['folder'] == 'unread' ? $eps_mail_unread : ($message['is_replied_to'] ? $eps_mail_reply : ($message['is_unread']  ? $eps_mail_unread : $eps_mail_read))), '</td>]]></add>
	</operation>
</file>
</modification>