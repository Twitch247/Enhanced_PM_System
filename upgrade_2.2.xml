<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Enhanced_PM_System</id>
<version>2.2</version>

<!---------------------------------------------------------------------------->
<!-- Re-addition of code that removes the default subject from PMs			-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[$context['subject'] = $form_subject != '' ? $form_subject : $txt['no_subject'];]]></search>
		<add><![CDATA[$context['subject'] = $form_subject != '' ? $form_subject : '';]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Fixed bug that marks PMs read even though user hasn't opened the PM.   -->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[elseif (!empty($context['current_pm']))]]></search>
		<add><![CDATA[elseif (!empty($context['current_pm']) && !empty($_GET['pmid']))]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Fixed bug that resulted in incorrect display mode being selected		-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="before"><![CDATA[// Now we have the labels, and assuming we have unsorted mail, apply our rules!]]></search>
		<add><![CDATA[
	$context['display_mode'] = WIRELESS ? 0 : (!empty($modSettings['eps_pm_view_switch']) ? $user_settings['pm_prefs'] & 3 : 2);]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Bug fixes so that PMs are able to be viewed if sender sent recipient   -->
<!-- another PM before recipient can read that one.                       	-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[// ... but wait - what if we want to start from a specific message?
	if (isset($_GET['pmid']))
	{
		$pmID = (int) $_GET['pmid'];

		// Make sure you have access to this PM.
		if (!isAccessiblePM($pmID, $context['folder'] == 'sent' || $context['folder'] == 'unread' ? 'outbox' : 'inbox'))]]></search>
		<add><![CDATA[// ... but wait - what if we want to start from a specific message?
	if (isset($_GET['pmid']))
	{
		$pmID = (int) $_GET['pmid'];

		// Make sure you have access to this PM.
		if (!isAccessiblePM($pmID, $context['folder'] == 'sent' ? 'in_or_outbox' : ($context['folder'] == 'unread' ? 'in_or_outbox' : 'inbox')))]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Sanitize and validate pmsg variable if set.
	if (isset($_GET['pmsg']))
	{
		$pmsg = (int) $_GET['pmsg'];

		if (!isAccessiblePM($pmsg, $context['folder'] == 'sent' || $context['folder'] == 'unread' ? 'outbox' : 'inbox'))]]></search>
		<add><![CDATA[// Sanitize and validate pmsg variable if set.
	if (isset($_GET['pmsg']))
	{
		$pmsg = (int) $_GET['pmsg'];

		if (!isAccessiblePM($pmsg, $context['folder'] == 'sent' ? 'in_or_outbox' : ($context['folder'] == 'unread' ? 'in_or_outbox' : 'inbox')))]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$lastData = array();]]></search>
		<add><![CDATA[$lastData = array('pms' => array());]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[	$lastData = array(
				'id' => $row['id_pm'],
				'head' => $row['id_pm_head'],
			);
	}
	$smcFunc['db_free_result']($request);

	// Make sure that we have been given a correct head pm id!
	if ($context['display_mode'] == 2 && !empty($pmID) && $pmID != $lastData['id'])]]></search>
		<add><![CDATA[{
			$lastData['id'] = $row['id_pm'];
			$lastData['head'] = $row['id_pm_head'];
			$lastData['pms'][] = $row['id_pm'];
		}
	}
	$smcFunc['db_free_result']($request);

	// Make sure that we have been given a correct head pm id!
	if ($context['display_mode'] == 2 && !empty($pmID) && in_array($pmID, $lastData['id']))]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Indentation fix for Curve PersonalMessage.template.php					-->
<!---------------------------------------------------------------------------->
<file name="$boarddir/Themes/default/PersonalMessage.template.php">
	<operation>
		<search position="replace"><![CDATA[// Show the conversation buttons.
			echo '
					<div class="pagesection">';

			if ($context['folder'] != 'unread')
        template_button_strip($conversation_buttons, 'right');]]></search>
		<add><![CDATA[// Show the conversation buttons.
			echo '
					<div class="pagesection">';

			if ($context['folder'] != 'unread')
				template_button_strip($conversation_buttons, 'right');]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- "Quote to All" feature implemented within PersonalMessage.template.php	-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[<li class="quote_button"><a href="', $scripturl, '?action=pm;sa=send;f=', $context['folder'], $context['current_label_id'] != -1 ? ';l=' . $context['current_label_id'] : '', ';pmsg=', $message['id'], ';quote', $context['folder'] == 'sent' ? '' : ';u=' . $message['member']['id'], '">', $txt['quote'], '</a></li>';]]></search>
		<add><![CDATA[<li class="quote_button"><a href="', $scripturl, '?action=pm;sa=send;f=', $context['folder'], $context['current_label_id'] != -1 ? ';l=' . $context['current_label_id'] : '', ';pmsg=', $message['id'], ';quote', $context['folder'] == 'sent' ? '' : ';u=' . $message['member']['id'], '">', $txt['quote'], '</a></li>
					<li class="quote_button"><a href="', $scripturl, '?action=pm;sa=send;f=', $context['folder'], $context['current_label_id'] != -1 ? ';l=' . $context['current_label_id'] : '', ';pmsg=', $message['id'], ';quote;u=all">', $txt['quote_to_all'], '</a></li>';]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Bug fix for no Search button with the Search PM code					-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[</fieldset></div>
		<p><input type="submit" name="submit" value="', $txt['pm_search_go'], '" class="button_submit floatright" /></p>';
		}]]></search>
		<add><![CDATA[</fieldset></div>';
		}
		echo '
		<p><input type="submit" name="submit" value="', $txt['pm_search_go'], '" class="button_submit floatright" /></p>';]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Template error fix for Core theme's PersonalMessage.template.php		-->
<!---------------------------------------------------------------------------->
<file name="$boarddir/Themes/core/PersonalMessage.template.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[echo '
							if ($context['folder'] != 'unread' || ($context['folder'] == 'unread' && isset($message['is_unread'])))]]></search>
		<add><![CDATA[if ($context['folder'] != 'unread' || ($context['folder'] == 'unread' && isset($message['is_unread'])))]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- English Language String Additions 										-->
<!---------------------------------------------------------------------------->
<file name="$languagedir/PersonalMessage.english.php">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english-utf8.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english_british.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english_british-utf8.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
</modification>