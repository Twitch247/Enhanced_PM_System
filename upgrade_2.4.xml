<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Enhanced_PM_System</id>
<version>2.4</version>

<!---------------------------------------------------------------------------->
<!-- 2nd Bug fix attempt for extremely bizarre bug version 2.3 introduced	-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[// Changing view?]]></search>
		<add><![CDATA[// Save some variables before we start:
	$tmparr = array(
		'start' => isset($_GET['start']) ? $_GET['start'] : 0,
		'pmid' => isset($_GET['pmid']) ? $_GET['pmid'] : 0,
		'sort' => isset($_GET['sort']) ? $_GET['sort'] : 0,
		'f' => isset($_GET['f']) ? $_GET['f'] : 0,
	);
	
	// Changing view?]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if ($context['display_mode'] == 2 && !empty($pmID) && $pmID != $lastData['id'])
		redirectexit('action=pm;pmid=' . $lastData['id'] . ';kstart;f=' . $context['folder'] . ';start=0;sort=date;#msg' . $lastData['id']);]]></search>
		<add><![CDATA[if ($context['display_mode'] == 2 && !empty($pmID) && !empty($lastData['id']) && $pmID != $lastData['id'])
		redirectexit('action=pm;pmid=' . $lastData['id'] . (isset($_GET['kstart']) ? ';kstart' : '') . (isset($_GET['f']) ? ';f=' . $tmparr['f'] : '') . (isset($_GET['start']) ? ';start=' . $tmparr['start'] : '') . (isset($_GET['sort']) ? ';sort=' . $tmparr['sort'] : '') . (isset($tmparr['pmid']) ? '#msg' . $tmparr['pmid'] : ''));
	elseif ($context['display_mode'] == 2 && !empty($pmID) && $pmID != $lastData['id'])
		fatal_lang_error('no_access', false);]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[$lastData['head'] = $row['id_pm_head'];
			$lastData['pms'][] = $row['id_pm'];]]></search>
		<add><![CDATA[$lastData['head'] = $row['id_pm_head'];]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- English Language String Corrections									-->
<!---------------------------------------------------------------------------->
<file name="$languagedir/Modifications.english.php">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';;]]></search>
		<add><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english-utf8.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';;]]></search>
		<add><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english_british.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';;]]></search>
		<add><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english_british-utf8.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';;]]></search>
		<add><![CDATA[$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';]]></add>
	</operation>
</file>
</modification>