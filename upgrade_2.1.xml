<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Enhanced_PM_System</id>
<version>2.1</version>

<!---------------------------------------------------------------------------->
<!-- If enabled, allow muted members to send Personal Messages            	-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/Security.php">
	<operation>
		<search position="replace"><![CDATA[$denied_permissions = array(
			'pm_send',]]></search>
		<add><![CDATA[$denied_permissions = array(]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['post_unapproved_topics', 'post_unapproved_replies_own', 'post_unapproved_replies_any',
		);]]></search>
		<add><![CDATA[
		if (!isset($modSettings['eps_send_pm_while_muted']) || !$modSettings['eps_send_pm_while_muted'])
			$denied_permissions[] = 'pm_send';]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageSettings.php">
	<operation>
		<search position="before"><![CDATA[array('check', 'eps_block_1st_day'),]]></search>
		<add><![CDATA[
			array('check', 'eps_send_pm_while_muted'),]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Fixed a bug where user info is not updated when sent a new PM			-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/Subs-Post.php">
	<operation>
		<search position="replace"><![CDATA[// Add one to their unread and read message counts.
	if (empty($pmsg))]]></search>
		<add><![CDATA[// Add one to their unread and read message counts.
	if (empty($pmsg) || !isset($_REQUEST['edit']))]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Removal of code that places default subject title into PM				-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[$context['subject'] = $form_subject != '' ? $form_subject : '';]]></search>
		<add><![CDATA[$context['subject'] = $form_subject != '' ? $form_subject : $txt['no_subject'];]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Bug fix where the PM display mode not being set correctly				-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[// Changing view?
	if (isset($_GET['view']))
	{
		$context['display_mode'] = $context['display_mode'] > 1 ? 0 : $context['display_mode'] + 1;
		updateMemberData($user_info['id'], array('pm_prefs' => ($user_settings['pm_prefs'] & 252) | $context['display_mode']));
	}

	// Set the PM view to conversation mode unless admin settings allow users to select a different view:
	if (empty($modSettings['eps_pm_view_switch']))
		$context['display_mode'] = 2;]]></search>
		<add><![CDATA[// Changing view?
	if (isset($_GET['view']))
	{
		$context['display_mode'] = $context['display_mode'] > 1 ? 0 : $context['display_mode'] + 1;
		updateMemberData($user_info['id'], array('pm_prefs' => ($user_settings['pm_prefs'] & 252) | $context['display_mode']));
	}]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Preferences...]]></search>
		<add><![CDATA[// Set the PM view to conversation mode unless admin settings allow users to select a different view:
	if (empty($modSettings['eps_pm_view_switch']))
	{
		$context['display_mode'] = 2;
		unset($_GET['view']);
	}

	// Preferences...]]></add>
	</operation>

<!---------------------------------------------------------------------------->
<!-- Bug fix where a PM message is read by the user and still marked NEW	-->
<!---------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[// Otherwise do just the current one!
		elseif (!empty($context['current_pm']) && ($context['display_mode'] == 1 || (isset($_GET['pmid']) && $context['folder'] != 'unread')))
			markMessages($display_pms, $context['current_label_id']);]]></search>
		<add><![CDATA[// Otherwise do just the current one!
		elseif (!empty($context['current_pm']))
			markMessages($display_pms, $context['current_label_id']);]]></add>
	</operation>


<!-------------------------------------------------------------------------->
<!-- Fix for improper deleting of messages from Outbox folders            -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[if ($folder == 'sent' || $folder === null)]]></search>
		<add><![CDATA[if ($folder == 'sent' || $folder == 'unread' || $folder === null)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if ($folder != 'sent' || $folder === null)]]></search>
		<add><![CDATA[if (($folder != 'sent' && $folder != 'unread') || $folder === null)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[deleteMessages(null, $_REQUEST['f'] != 'sent' ? 'inbox' : 'sent');]]></search>
		<add><![CDATA[deleteMessages(null, $_REQUEST['f'] != 'sent' ? ($_REQUEST['f'] != 'unread' ? 'inbox' : 'unread') : 'sent');]]></add>
	</operation>
	
<!-------------------------------------------------------------------------->
<!-- When disabled, allow users to block PMs from Admins by using rules   -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="before"><![CDATA[function ManageRules()
{
	global $txt, $context, $user_info, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $modSettings]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND mg.hidden = {int:not_hidden}]]></search>
		<add><![CDATA[
			AND mg.id_group != {int:admin_group}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['not_hidden' => 0,]]></search>
		<add><![CDATA[
			'admin_group' => (!isset($modSettings['eps_allow_block_admin']) || !$modSettings['eps_allow_block_admin'] ? 1 : 0),]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- English Language String Additions (PersonalMessage)					-->
<!---------------------------------------------------------------------------->
<file name="$languagedir/PersonalMessage.english.php">
	<operation>
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english-utf8.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english_british.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>
<file name="$languagedir/PersonalMessage.english_british-utf8.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></search>
		<add><![CDATA[$txt['reply_to_all'] = 'Reply to All';
$txt['quote_to_all'] = 'Quote to All';
$txt['delete_conversation'] = 'Delete Conversation';]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- English Language String Additions (Modifications)						-->
<!---------------------------------------------------------------------------->
<file name="$languagedir/Modifications.english.php">
	<operation>
		<search position="replace"><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
/* End Enhanced PM System mod */]]></search>
		<add><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
$txt['eps_send_pm_while_muted'] = 'Allow muted members to send PMs';
$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';
/* End Enhanced PM System mod */]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english-utf8.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
/* End Enhanced PM System mod */]]></search>
		<add><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
$txt['eps_send_pm_while_muted'] = 'Allow muted members to send PMs';
$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';
/* End Enhanced PM System mod */]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english_british.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
/* End Enhanced PM System mod */]]></search>
		<add><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
$txt['eps_send_pm_while_muted'] = 'Allow muted members to send PMs';
$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';
/* End Enhanced PM System mod */]]></add>
	</operation>
</file>
<file name="$languagedir/Modifications.english_british-utf8.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
/* End Enhanced PM System mod */]]></search>
		<add><![CDATA[$txt['eps_block_1st_day'] = 'Block ability to PM anybody for first day';
$txt['eps_send_pm_while_muted'] = 'Allow muted members to send PMs';
$txt['eps_allow_block_admin'] = 'Allow members to block Admin PMs in PM rules';
/* End Enhanced PM System mod */]]></add>
	</operation>
</file>
</modification>